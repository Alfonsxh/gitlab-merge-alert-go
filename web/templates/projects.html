<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}} - GitLab Merge Alert</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/common.css" rel="stylesheet">
    <script src="/static/js/vue.global.min.js"></script>
    <script src="/static/js/axios.min.js"></script>
    <style>
        /* 各列宽度设置 - 项目管理特定样式 */
        .table th:nth-child(1) { width: 60px; }   /* ID */
        .table th:nth-child(2) { width: 200px; }  /* 项目名称 */
        .table th:nth-child(3) { width: 100px; }  /* GitLab项目ID */
        .table th:nth-child(4) { width: 200px; }  /* 描述 */
        .table th:nth-child(5) { width: 120px; }  /* GitLab Webhook */
        .table th:nth-child(6) { width: 180px; }  /* 关联Webhook */
        .table th:nth-child(7) { width: 120px; }  /* 创建时间 */
        .table th:nth-child(8) { width: 120px; }  /* 操作 */
    </style>
</head>
<body>
    <nav class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
        <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="/">GitLab Merge Alert</a>
        <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu">
            <span class="navbar-toggler-icon"></span>
        </button>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link{{if eq .currentPage "dashboard"}} active{{end}}" href="/">
                                <i class="bi bi-house"></i> 仪表板
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link{{if eq .currentPage "users"}} active{{end}}" href="/users">
                                <i class="bi bi-people"></i> 用户管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link{{if eq .currentPage "projects"}} active{{end}}" href="/projects">
                                <i class="bi bi-folder"></i> 项目管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link{{if eq .currentPage "webhooks"}} active{{end}}" href="/webhooks">
                                <i class="bi bi-link-45deg"></i> Webhook管理
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main">
                <div id="app">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">项目管理</h1>
        <button type="button" class="btn btn-primary" @click="showAddModal">
            <i class="bi bi-plus"></i> 添加项目
        </button>
    </div>

    <!-- 项目列表 -->
    <div v-if="projects.length === 0" class="card">
        <div class="card-body text-center py-5">
            <div class="text-muted">
                <i class="bi bi-folder-x fs-1 mb-3 d-block"></i>
                <p class="mb-2">还没有添加任何项目</p>
                <p class="small">点击上方的"添加项目"按钮开始添加项目</p>
            </div>
        </div>
    </div>

    <!-- 简化的项目列表显示用于调试 -->
    <div v-else class="projects-simple">
        <div class="alert alert-info">
            找到 <span v-text="projects.length"></span> 个项目，分组数量：<span v-text="Object.keys(groupedProjects).length"></span>
        </div>
        
        <!-- 按组分组显示项目 -->
        <div class="projects-grouped">
        <div v-for="(groupProjects, groupName) in groupedProjects" :key="groupName" class="group-section">
            <button class="group-header w-100 text-start" :class="{ collapsed: collapsedGroups[groupName] }" @click="toggleGroup(groupName)">
                <div class="d-flex align-items-center">
                    <i class="bi" :class="collapsedGroups[groupName] ? 'bi-chevron-right' : 'bi-chevron-down'" style="width: 1rem;"></i>
                    <span class="ms-2 fw-bold" v-text="groupName"></span>
                    <span class="group-badge" v-text="groupProjects.length + ' 个项目'"></span>
                </div>
                <small class="opacity-75">点击展开/收起</small>
            </button>
            
            <div v-show="!collapsedGroups[groupName]" class="group-content">
                <div class="overflow-hidden">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th class="project-name-col">项目名称</th>
                                <th>GitLab项目ID</th>
                                <th>描述</th>
                                <th>GitLab Webhook</th>
                                <th>关联Webhook</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="project in groupProjects" :key="project.id">
                                <td class="no-wrap" v-text="project.id">-</td>
                                <td class="project-name-col">
                                    <a :href="project.url" target="_blank" class="text-decoration-none" :title="project.name">
                                        <span v-text="project.name">-</span>
                                        <i class="bi bi-box-arrow-up-right ms-1"></i>
                                    </a>
                                </td>
                                <td class="no-wrap" v-text="project.gitlab_project_id">-</td>
                                <td>
                                    <span data-bs-toggle="tooltip" :title="project.description || '-'" 
                                          class="text-truncate d-inline-block" style="max-width: 200px;"
                                          v-text="project.description || '-'">-</span>
                                </td>
                                <td class="no-wrap">
                                    <div class="d-flex align-items-center">
                                        <span v-if="project.webhook_synced" class="badge bg-success me-2">
                                            <i class="bi bi-check-circle me-1"></i>已同步
                                        </span>
                                        <span v-else class="badge bg-warning me-2">
                                            <i class="bi bi-exclamation-triangle me-1"></i>未同步
                                        </span>
                                        <button v-if="project.auto_manage_webhook" 
                                                class="btn btn-sm btn-outline-primary" 
                                                @click="syncGitLabWebhook(project)"
                                                :disabled="syncingWebhook === project.id"
                                                data-bs-toggle="tooltip" title="同步GitLab Webhook">
                                            <i class="bi bi-arrow-repeat" :class="{'spin': syncingWebhook === project.id}"></i>
                                        </button>
                                    </div>
                                </td>
                                <td>
                                    <div class="text-truncate-long" :title="getWebhooksText(project.webhooks)">
                                        <span v-for="webhook in project.webhooks" :key="webhook.id" class="badge bg-secondary me-1" v-text="webhook.name">-</span>
                                        <span v-if="!project.webhooks || project.webhooks.length === 0" class="text-muted">无</span>
                                    </div>
                                </td>
                                <td class="no-wrap" v-text="formatDate(project.created_at)">-</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-success me-1" @click="manageWebhooks(project)" data-bs-toggle="tooltip" title="管理Webhook关联">
                                        <i class="bi bi-link"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary me-1" @click="editProject(project)" data-bs-toggle="tooltip" title="编辑项目">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" @click="deleteProject(project.id)" data-bs-toggle="tooltip" title="删除项目">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        </div>
    </div>

    <!-- 添加/编辑项目模态框 -->
    <div class="modal fade" id="projectModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" v-text="isEditing ? '编辑项目' : '添加项目'">项目管理</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- 步骤指示器 -->
                    <div class="mb-4" v-if="!isEditing">
                        <div class="progress" style="height: 4px;">
                            <div class="progress-bar" role="progressbar" :style="{width: getProgressWidth}"></div>
                        </div>
                        <div class="row mt-2" v-if="!isBatchMode">
                            <div class="col-4 text-center">
                                <small :class="urlParseStep === 'input' ? 'text-primary fw-bold' : 'text-muted'">1. 输入URL和Token</small>
                            </div>
                            <div class="col-4 text-center">
                                <small :class="urlParseStep === 'parsing' ? 'text-primary fw-bold' : 'text-muted'">2. 解析项目信息</small>
                            </div>
                            <div class="col-4 text-center">
                                <small :class="urlParseStep === 'confirm' ? 'text-primary fw-bold' : 'text-muted'">3. 确认保存</small>
                            </div>
                        </div>
                        <div class="row mt-2" v-else>
                            <div class="col-3 text-center">
                                <small :class="urlParseStep === 'input' ? 'text-primary fw-bold' : 'text-muted'">1. 输入URL和Token</small>
                            </div>
                            <div class="col-3 text-center">
                                <small :class="urlParseStep === 'parsing' ? 'text-primary fw-bold' : 'text-muted'">2. 扫描组项目</small>
                            </div>
                            <div class="col-3 text-center">
                                <small :class="urlParseStep === 'batch_select' ? 'text-primary fw-bold' : 'text-muted'">3. 选择项目和配置</small>
                            </div>
                            <div class="col-3 text-center">
                                <small :class="urlParseStep === 'confirm' ? 'text-primary fw-bold' : 'text-muted'">4. 批量创建</small>
                            </div>
                        </div>
                    </div>

                    <!-- 第一步：URL和Token输入 -->
                    <div v-if="!isEditing && urlParseStep === 'input'">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            输入GitLab项目或组URL和访问令牌，系统将自动识别并获取信息
                            <br><small>• 项目URL: https://gitlab.com/group/project</small>
                            <br><small>• 组URL: https://gitlab.com/group（将扫描组下所有项目）</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="gitlab_url" class="form-label">GitLab项目或组URL *</label>
                            <input type="url" class="form-control" id="gitlab_url" v-model="urlParseForm.url" 
                                   placeholder="https://gitlab.com/group/project 或 https://gitlab.com/group" required>
                            <div class="form-text">支持GitLab.com或私有GitLab实例的项目URL或组URL</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="gitlab_token" class="form-label">
                                GitLab个人访问令牌 *
                                <button type="button" class="btn btn-link btn-sm p-0 ms-1" @click="showTokenHelp = !showTokenHelp">
                                    <i class="bi bi-question-circle"></i>
                                </button>
                                <a v-if="configGitlabTokenUrl" :href="configGitlabTokenUrl" target="_blank" class="btn btn-link btn-sm p-0 ms-1">
                                    <i class="bi bi-box-arrow-up-right"></i> 生成令牌
                                </a>
                            </label>
                            <div class="input-group">
                                <input :type="showToken ? 'text' : 'password'" class="form-control" id="gitlab_token" 
                                       v-model="urlParseForm.access_token" placeholder="glpat-xxxxxxxxxxxx" required>
                                <button type="button" class="btn btn-outline-secondary" @click="showToken = !showToken">
                                    <i :class="showToken ? 'bi bi-eye-slash' : 'bi bi-eye'"></i>
                                </button>
                            </div>
                            <div class="form-text">需要 read_api 权限的个人访问令牌</div>
                        </div>

                        <!-- Token帮助信息 -->
                        <div v-if="showTokenHelp" class="alert alert-light border">
                            <h6><i class="bi bi-lightbulb me-2"></i>如何获取GitLab个人访问令牌？</h6>
                            <div class="row">
                                <div class="col-md-8">
                                    <ol class="mb-0">
                                        <li>登录GitLab，进入 "用户设置" → "访问令牌"</li>
                                        <li>创建新的个人访问令牌</li>
                                        <li>选择权限：至少需要 <code>read_api</code> 和 <code>read_repository</code></li>
                                        <li>复制生成的令牌（以glpat-开头）</li>
                                    </ol>
                                </div>
                                <div class="col-md-4 text-end">
                                    <a v-if="configGitlabTokenUrl" :href="configGitlabTokenUrl" target="_blank" class="btn btn-primary btn-sm">
                                        <i class="bi bi-box-arrow-up-right me-1"></i>
                                        直接前往生成
                                    </a>
                                    <small v-else class="text-muted d-block">GitLab配置加载中...</small>
                                </div>
                            </div>
                        </div>

                        <!-- 连接测试结果 -->
                        <div v-if="connectionTestResult" class="alert" :class="connectionTestResult.success ? 'alert-success' : 'alert-danger'">
                            <i :class="connectionTestResult.success ? 'bi bi-check-circle' : 'bi bi-exclamation-triangle'" class="me-2"></i>
                            <span v-text="connectionTestResult.message"></span>
                        </div>
                    </div>

                    <!-- 第二步：解析中状态 -->
                    <div v-if="!isEditing && urlParseStep === 'parsing'" class="text-center py-4">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">扫描中...</span>
                        </div>
                        <h5>正在扫描GitLab...</h5>
                        <p class="text-muted">正在识别URL类型并获取相关信息，请稍候...</p>
                        <div class="progress" style="width: 200px; margin: 0 auto;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                        </div>
                    </div>

                    <!-- 第三步：批量项目选择和配置 -->
                    <div v-if="!isEditing && urlParseStep === 'batch_select'">
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>
                            <span v-if="scannedData.group_info">
                                成功扫描到组 "<strong v-text="scannedData.group_info.name"></strong>" 
                                下共 <strong v-text="scannedData.projects.length"></strong> 个项目
                            </span>
                            <span v-else>扫描完成，请选择要添加的项目</span>
                        </div>

                        <!-- 项目选择 -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">选择项目</h6>
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-primary me-2" @click="selectAllProjects">全选</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" @click="deselectAllProjects">取消全选</button>
                                </div>
                            </div>
                            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                                <div class="row">
                                    <div class="col-md-6" v-for="project in scannedData.projects" :key="project.id">
                                        <div class="card border mb-2" :class="project.selected ? 'border-primary bg-light' : ''">
                                            <div class="card-body p-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" 
                                                           :id="'project-' + project.id" v-model="project.selected">
                                                    <label class="form-check-label w-100" :for="'project-' + project.id">
                                                        <strong v-text="project.name"></strong>
                                                        <br>
                                                        <small class="text-muted" v-text="project.path_with_namespace"></small>
                                                        <br>
                                                        <small class="text-secondary" v-text="project.description || '无描述'"></small>
                                                        <div class="mt-1">
                                                            <span class="badge" :class="project.visibility === 'public' ? 'bg-success' : project.visibility === 'internal' ? 'bg-warning' : 'bg-secondary'" v-text="project.visibility"></span>
                                                        </div>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div v-if="scannedData.projects.length === 0" class="text-center text-muted py-4">
                                    <i class="bi bi-folder-x fs-1 text-muted"></i>
                                    <p class="mt-2">没有找到任何项目</p>
                                </div>
                            </div>
                        </div>

                        <!-- Webhook配置 -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Webhook配置</h6>
                            </div>
                            <div class="card-body">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="use_unified" v-model="batchWebhookConfig.use_unified">
                                    <label class="form-check-label" for="use_unified">
                                        使用统一Webhook（所有选中项目使用相同的Webhook）
                                    </label>
                                </div>

                                <!-- 统一Webhook配置 -->
                                <div v-if="batchWebhookConfig.use_unified">
                                    <div class="mb-3">
                                        <label class="form-label">选择现有Webhook</label>
                                        <select class="form-select" v-model="batchWebhookConfig.unified_webhook_id">
                                            <option value="">选择一个现有的Webhook</option>
                                            <template v-for="webhook in allWebhooks" :key="webhook?.id || Math.random()">
                                                <option v-if="webhook && webhook.id" :value="webhook.id" v-text="webhook.name + ' - ' + webhook.url">
                                                </option>
                                            </template>
                                        </select>
                                    </div>
                                    
                                    <div class="text-center my-3">
                                        <span class="text-muted">-- 或者 --</span>
                                    </div>

                                    <div class="border rounded p-3">
                                        <h6>创建新的Webhook</h6>
                                        <div class="mb-3">
                                            <label class="form-label">名称</label>
                                            <input type="text" class="form-control" v-model="batchWebhookConfig.new_webhook.name" 
                                                   placeholder="例如: 开发团队通知群">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Webhook URL</label>
                                            <input type="url" class="form-control" v-model="batchWebhookConfig.new_webhook.url" 
                                                   placeholder="https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">描述</label>
                                            <textarea class="form-control" v-model="batchWebhookConfig.new_webhook.description" 
                                                      rows="2" placeholder="描述这个Webhook的用途"></textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- 单独配置提示 -->
                                <div v-else class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    取消统一配置后，项目将先创建，您可以稍后在项目管理页面单独为每个项目配置Webhook
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 第四步/第三步：确认项目信息 -->
                    <div v-if="!isEditing && urlParseStep === 'confirm' && !isBatchMode">
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>
                            项目信息解析成功！请确认以下信息
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">GitLab项目ID</label>
                                    <input type="text" class="form-control" :value="parsedProjectInfo.gitlab_project_id" readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="parsed_name" class="form-label">项目名称 *</label>
                                    <input type="text" class="form-control" id="parsed_name" v-model="parsedProjectInfo.name" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">项目路径</label>
                                    <input type="text" class="form-control" :value="parsedProjectInfo.path_with_namespace" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">项目URL</label>
                                    <input type="text" class="form-control" :value="parsedProjectInfo.web_url" readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="parsed_description" class="form-label">项目描述</label>
                                    <textarea class="form-control" id="parsed_description" v-model="parsedProjectInfo.description" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">可见性</label>
                                    <input type="text" class="form-control" :value="parsedProjectInfo.visibility" readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Webhook配置 -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">Webhook配置</h6>
                            </div>
                            <div class="card-body">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="use_existing_webhook" v-model="singleWebhookConfig.use_existing">
                                    <label class="form-check-label" for="use_existing_webhook">
                                        使用现有Webhook
                                    </label>
                                </div>

                                <!-- 现有Webhook选择 -->
                                <div v-if="singleWebhookConfig.use_existing">
                                    <div class="mb-3">
                                        <label class="form-label">选择现有Webhook</label>
                                        <select class="form-select" v-model="singleWebhookConfig.existing_webhook_id">
                                            <option value="">选择一个现有的Webhook</option>
                                            <template v-for="webhook in allWebhooks" :key="webhook?.id || Math.random()">
                                                <option v-if="webhook && webhook.id" :value="webhook.id" v-text="webhook.name + ' - ' + webhook.url">
                                                </option>
                                            </template>
                                        </select>
                                    </div>
                                </div>

                                <!-- 创建新Webhook -->
                                <div v-else>
                                    <div class="text-center my-3">
                                        <span class="text-muted">-- 创建新的Webhook --</span>
                                    </div>

                                    <div class="border rounded p-3">
                                        <h6>新Webhook信息</h6>
                                        <div class="mb-3">
                                            <label class="form-label">名称 *</label>
                                            <input type="text" class="form-control" v-model="singleWebhookConfig.new_webhook.name" 
                                                   placeholder="例如: 开发团队通知群" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Webhook URL *</label>
                                            <input type="url" class="form-control" v-model="singleWebhookConfig.new_webhook.url" 
                                                   placeholder="https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">描述</label>
                                            <textarea class="form-control" v-model="singleWebhookConfig.new_webhook.description" 
                                                      rows="2" placeholder="描述这个Webhook的用途"></textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- 不配置Webhook提示 -->
                                <div v-if="!singleWebhookConfig.use_existing && !singleWebhookConfig.new_webhook.name && !singleWebhookConfig.new_webhook.url" class="alert alert-info mt-3">
                                    <i class="bi bi-info-circle me-2"></i>
                                    未配置Webhook - 项目将创建但不关联任何Webhook，您可以稍后在项目管理页面配置
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 批量创建确认页面 -->
                    <div v-if="!isEditing && urlParseStep === 'confirm' && isBatchMode">
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>
                            即将批量创建 <strong v-text="selectedProjectsCount"></strong> 个项目
                        </div>

                        <!-- 选中的项目列表 -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">选中的项目</h6>
                            </div>
                            <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                                <div class="row">
                                    <div class="col-md-6" v-for="project in scannedData.projects.filter(p => p.selected)" :key="project.id">
                                        <div class="card border-0 bg-light mb-2">
                                            <div class="card-body p-2">
                                                <h6 class="card-title mb-1" v-text="project.name"></h6>
                                                <small class="text-muted" v-text="project.path_with_namespace"></small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Webhook配置摘要 -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Webhook配置摘要</h6>
                            </div>
                            <div class="card-body">
                                <div v-if="batchWebhookConfig.use_unified">
                                    <div v-if="batchWebhookConfig.unified_webhook_id">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-link me-2 text-success"></i>
                                            <span>使用现有Webhook: </span>
                                            <template v-for="webhook in allWebhooks" :key="webhook?.id || Math.random()">
                                                <span v-if="webhook && webhook.id && webhook.id == batchWebhookConfig.unified_webhook_id">
                                                    <strong v-text="webhook.name"></strong>
                                                </span>
                                            </template>
                                        </div>
                                    </div>
                                    <div v-else-if="batchWebhookConfig.new_webhook.name && batchWebhookConfig.new_webhook.url">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-plus-circle me-2 text-primary"></i>
                                            <span>创建新Webhook: <strong v-text="batchWebhookConfig.new_webhook.name"></strong></span>
                                        </div>
                                    </div>
                                    <div v-else>
                                        <div class="d-flex align-items-center text-warning">
                                            <i class="bi bi-exclamation-triangle me-2"></i>
                                            <span>未配置Webhook - 项目将创建但不关联任何Webhook</span>
                                        </div>
                                    </div>
                                </div>
                                <div v-else>
                                    <div class="d-flex align-items-center text-info">
                                        <i class="bi bi-info-circle me-2"></i>
                                        <span>不使用统一配置 - 项目将创建，可稍后单独配置Webhook</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 编辑模式的传统表单 -->
                    <div v-if="isEditing">
                        <form @submit.prevent="saveProject">
                            <div class="mb-3">
                                <label for="edit_gitlab_project_id" class="form-label">GitLab项目ID *</label>
                                <input type="number" class="form-control" id="edit_gitlab_project_id" v-model="currentProject.gitlab_project_id" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit_name" class="form-label">项目名称 *</label>
                                <input type="text" class="form-control" id="edit_name" v-model="currentProject.name" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit_url" class="form-label">项目URL *</label>
                                <input type="url" class="form-control" id="edit_url" v-model="currentProject.url" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit_description" class="form-label">描述</label>
                                <textarea class="form-control" id="edit_description" v-model="currentProject.description" rows="3"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="edit_access_token" class="form-label">访问令牌</label>
                                <input type="password" class="form-control" id="edit_access_token" v-model="currentProject.access_token">
                                <div class="form-text">留空表示不更改现有令牌</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">关联Webhooks</label>
                                <div class="list-group" style="max-height: 150px; overflow-y: auto;">
                                    <label v-for="webhook in allWebhooks" :key="webhook.id" class="list-group-item">
                                        <input class="form-check-input me-1" type="checkbox" :value="webhook.id" v-model="currentProject.webhook_ids">
                                        <span v-text="webhook.name"></span>
                                        <small class="text-muted d-block" v-text="webhook.url"></small>
                                    </label>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    
                    <!-- 第一步的按钮 -->
                    <div v-if="!isEditing && urlParseStep === 'input'">
                        <button type="button" class="btn btn-outline-primary me-2" @click="testConnection" :disabled="!urlParseForm.url || !urlParseForm.access_token || connectionTesting">
                            <span v-if="connectionTesting" class="spinner-border spinner-border-sm me-2"></span>
                            测试连接
                        </button>
                        <button type="button" class="btn btn-primary" @click="parseProjectURL" :disabled="!urlParseForm.url || !urlParseForm.access_token || urlParsing">
                            <span v-if="urlParsing" class="spinner-border spinner-border-sm me-2"></span>
                            开始扫描
                        </button>
                    </div>
                    
                    <!-- 批量选择步骤的按钮 -->
                    <div v-if="!isEditing && urlParseStep === 'batch_select'">
                        <button type="button" class="btn btn-outline-secondary me-2" @click="urlParseStep = 'input'">
                            重新扫描
                        </button>
                        <button type="button" class="btn btn-primary" @click="proceedToBatchConfirm" :disabled="!hasSelectedProjects">
                            下一步：确认创建 (<span v-text="selectedProjectsCount"></span> 个项目)
                        </button>
                    </div>
                    
                    <!-- 批量确认步骤的按钮 -->
                    <div v-if="!isEditing && urlParseStep === 'confirm' && isBatchMode">
                        <button type="button" class="btn btn-outline-secondary me-2" @click="urlParseStep = 'batch_select'">
                            返回选择
                        </button>
                        <button type="button" class="btn btn-primary" @click="batchCreateProjects" :disabled="projectSaving">
                            <span v-if="projectSaving" class="spinner-border spinner-border-sm me-2"></span>
                            批量创建项目
                        </button>
                    </div>

                    <!-- 单个项目确认步骤的按钮 -->
                    <div v-if="!isEditing && urlParseStep === 'confirm' && !isBatchMode">
                        <button type="button" class="btn btn-outline-secondary me-2" @click="urlParseStep = 'input'">
                            返回修改
                        </button>
                        <button type="button" class="btn btn-primary" @click="saveProject" :disabled="projectSaving || !isValidSingleWebhookConfig">
                            <span v-if="projectSaving" class="spinner-border spinner-border-sm me-2"></span>
                            保存项目
                        </button>
                    </div>
                    
                    <!-- 编辑模式的按钮 -->
                    <button v-if="isEditing" type="button" class="btn btn-primary" @click="saveProject" :disabled="projectSaving">
                        <span v-if="projectSaving" class="spinner-border spinner-border-sm me-2"></span>
                        更新项目
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Webhook关联管理模态框 -->
    <div class="modal fade" id="webhookModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">管理项目Webhook</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>项目: <span v-text="selectedProject?.name">-</span></h6>
                    <hr>
                    <template v-for="webhook in allWebhooks" :key="webhook?.id || Math.random()">
                        <div v-if="webhook && webhook.id" class="form-check">
                            <input class="form-check-input" type="checkbox" :id="'webhook-' + webhook.id" 
                                   :checked="isWebhookLinked(webhook.id)" @change="toggleWebhook(webhook.id)">
                            <label class="form-check-label" :for="'webhook-' + webhook.id">
                                <span v-text="webhook.name">-</span>
                                <small class="text-muted d-block" v-text="webhook.url">-</small>
                            </label>
                        </div>
                    </template>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/common.js"></script>
    <script>
        // Vue.js 应用
        const { createApp } = Vue;

        const vueApp = createApp({
            mixins: [CommonMixin],
            data() {
                return {
                    projects: [],
                    allWebhooks: [],
                    currentProject: {
                        id: null,
                        gitlab_project_id: '',
                        name: '',
                        url: '',
                        description: '',
                        access_token: ''
                    },
                    selectedProject: null,
                    isEditing: false,
                    
                    // URL解析相关的状态
                    urlParseStep: 'input', // 'input', 'parsing', 'confirm', 'batch_select'
                    urlParseForm: {
                        url: '',
                        access_token: ''
                    },
                    parsedProjectInfo: {
                        gitlab_project_id: null,
                        name: '',
                        description: '',
                        web_url: '',
                        path_with_namespace: '',
                        default_branch: '',
                        visibility: ''
                    },
                    
                    // 批量导入相关状态
                    scannedData: {
                        group_info: null,
                        projects: []
                    },
                    batchWebhookConfig: {
                        use_unified: true,
                        unified_webhook_id: null,
                        new_webhook: {
                            name: '',
                            url: '',
                            description: '',
                            is_active: true
                        },
                        project_webhooks: []
                    },
                    isBatchMode: false,
                    
                    // 单个项目的webhook配置
                    singleWebhookConfig: {
                        use_existing: false,
                        existing_webhook_id: null,
                        new_webhook: {
                            name: '',
                            url: '',
                            description: '',
                            is_active: true
                        }
                    },
                    
                    // UI状态控制
                    showToken: false,
                    showTokenHelp: false,
                    urlParsing: false,
                    connectionTesting: false,
                    projectSaving: false,
                    syncingWebhook: null, // 当前正在同步webhook的项目ID
                    connectionTestResult: null,
                    gitlabConfig: null,
                    collapsedGroups: {}
                }
            },
            computed: {
                configGitlabTokenUrl() {
                    if (!this.gitlabConfig || !this.gitlabConfig.gitlab_url) {
                        return null;
                    }
                    
                    try {
                        const url = new URL(this.gitlabConfig.gitlab_url);
                        return `${url.protocol}//${url.host}/-/profile/personal_access_tokens`;
                    } catch (e) {
                        return null;
                    }
                },
                selectedProjectsCount() {
                    return this.scannedData.projects.filter(p => p.selected).length;
                },
                hasSelectedProjects() {
                    return this.selectedProjectsCount > 0;
                },
                getProgressWidth() {
                    if (this.isBatchMode) {
                        // 批量模式：4步
                        if (this.urlParseStep === 'input') return '25%';
                        if (this.urlParseStep === 'parsing') return '50%';
                        if (this.urlParseStep === 'batch_select') return '75%';
                        return '100%';
                    } else {
                        // 单项目模式：3步
                        if (this.urlParseStep === 'input') return '33%';
                        if (this.urlParseStep === 'parsing') return '66%';
                        return '100%';
                    }
                },
                isValidSingleWebhookConfig() {
                    // 如果使用现有webhook，验证是否选择了webhook
                    if (this.singleWebhookConfig.use_existing) {
                        return true; // 允许不选择现有webhook（项目可以不关联webhook）
                    }
                    
                    // 如果创建新webhook，验证必填字段
                    if (!this.singleWebhookConfig.use_existing) {
                        // 如果没有填写任何新webhook信息，允许通过（不关联webhook）
                        if (!this.singleWebhookConfig.new_webhook.name && !this.singleWebhookConfig.new_webhook.url) {
                            return true;
                        }
                        
                        // 如果填写了部分信息，必须填写完整
                        return this.singleWebhookConfig.new_webhook.name && 
                               this.singleWebhookConfig.new_webhook.url;
                    }
                    
                    return true;
                },
                groupedProjects() {
                    // 智能分组：找到最小的有意义的分组级别
                    return this.createSmartGroups(this.projects);
                }
            },
            methods: {
                async loadProjects() {
                    try {
                        const response = await axios.get('/api/v1/projects');
                        this.projects = response.data.data || [];
                    } catch (error) {
                        console.error('Failed to load projects:', error);
                        alert('加载项目列表失败');
                    }
                },
                async loadGitLabConfig() {
                    try {
                        const response = await axios.get('/api/v1/gitlab/config');
                        this.gitlabConfig = response.data.data;
                    } catch (error) {
                        console.error('Failed to load GitLab config:', error);
                    }
                },
                async loadWebhooks() {
                    try {
                        console.log('Loading webhooks...');
                        const response = await axios.get('/api/v1/webhooks');
                        console.log('Raw API response:', response.data);
                        
                        const webhooks = response.data.data || [];
                        console.log('Webhooks from API:', webhooks);
                        
                        // 过滤并验证webhook数据，确保只包含有效对象
                        this.allWebhooks = webhooks.filter(webhook => {
                            const isValid = webhook && 
                                typeof webhook === 'object' && 
                                webhook.id && 
                                webhook.name && 
                                webhook.url;
                            if (!isValid) {
                                console.warn('Invalid webhook filtered out:', webhook);
                            }
                            return isValid;
                        });
                        
                        console.log('Loaded and filtered webhooks:', this.allWebhooks.length, this.allWebhooks);
                    } catch (error) {
                        console.error('Failed to load webhooks:', error);
                        // 确保即使出错也有一个有效的空数组
                        this.allWebhooks = [];
                    }
                },
                async showAddModal() {
                    // 重置所有状态
                    this.resetAddProjectState();
                    this.isEditing = false;
                    
                    // 确保allWebhooks是有效数组
                    if (!Array.isArray(this.allWebhooks)) {
                        this.allWebhooks = [];
                    }
                    
                    // 确保Webhook数据已加载
                    if (this.allWebhooks.length === 0) {
                        await this.loadWebhooks();
                    }
                    
                    const modal = new bootstrap.Modal(document.getElementById('projectModal'));
                    modal.show();
                },
                resetAddProjectState() {
                    this.urlParseStep = 'input';
                    this.urlParseForm = {
                        url: '',
                        access_token: ''
                    };
                    this.parsedProjectInfo = {
                        gitlab_project_id: null,
                        name: '',
                        description: '',
                        web_url: '',
                        path_with_namespace: '',
                        default_branch: '',
                        visibility: ''
                    };
                    this.currentProject = {
                        id: null,
                        gitlab_project_id: '',
                        name: '',
                        url: '',
                        description: '',
                        access_token: ''
                    };
                    this.scannedData = {
                        group_info: null,
                        projects: []
                    };
                    this.batchWebhookConfig = {
                        use_unified: true,
                        unified_webhook_id: null,
                        new_webhook: {
                            name: '',
                            url: '',
                            description: '',
                            is_active: true
                        },
                        project_webhooks: []
                    };
                    this.isBatchMode = false;
                    this.singleWebhookConfig = {
                        use_existing: false,
                        existing_webhook_id: null,
                        new_webhook: {
                            name: '',
                            url: '',
                            description: '',
                            is_active: true
                        }
                    };
                    this.showToken = false;
                    this.showTokenHelp = false;
                    this.urlParsing = false;
                    this.connectionTesting = false;
                    this.projectSaving = false;
                    this.connectionTestResult = null;
                },
                selectAllProjects() {
                    this.scannedData.projects.forEach(project => {
                        project.selected = true;
                    });
                },
                deselectAllProjects() {
                    this.scannedData.projects.forEach(project => {
                        project.selected = false;
                    });
                },
                proceedToBatchConfirm() {
                    if (!this.hasSelectedProjects) {
                        alert('请至少选择一个项目');
                        return;
                    }
                    
                    // 验证webhook配置
                    if (this.batchWebhookConfig.use_unified) {
                        const hasExistingWebhook = this.batchWebhookConfig.unified_webhook_id;
                        const hasNewWebhook = this.batchWebhookConfig.new_webhook.name && this.batchWebhookConfig.new_webhook.url;
                        
                        if (!hasExistingWebhook && !hasNewWebhook) {
                            if (!confirm('未配置Webhook，项目将创建但不关联任何Webhook。确定要继续吗？')) {
                                return;
                            }
                        }
                    }
                    
                    this.urlParseStep = 'confirm';
                },
                async batchCreateProjects() {
                    if (!this.hasSelectedProjects) {
                        alert('请至少选择一个项目');
                        return;
                    }

                    this.projectSaving = true;
                    
                    try {
                        // 准备批量创建请求数据
                        const selectedProjects = this.scannedData.projects.filter(p => p.selected);
                        const projectData = selectedProjects.map(project => ({
                            gitlab_project_id: project.id,
                            name: project.name,
                            url: project.web_url,
                            description: project.description || ''
                        }));

                        // 准备webhook配置
                        const webhookConfig = {
                            use_unified: this.batchWebhookConfig.use_unified,
                            unified_webhook_id: this.batchWebhookConfig.unified_webhook_id || null,
                            new_webhook: null,
                            project_webhooks: []
                        };

                        // 如果要创建新webhook且填写了信息
                        if (this.batchWebhookConfig.use_unified && 
                            this.batchWebhookConfig.new_webhook.name && 
                            this.batchWebhookConfig.new_webhook.url) {
                            webhookConfig.new_webhook = this.batchWebhookConfig.new_webhook;
                            webhookConfig.unified_webhook_id = null; // 创建新的，不使用现有的
                        }

                        const requestData = {
                            projects: projectData,
                            access_token: this.urlParseForm.access_token,
                            webhook_config: webhookConfig
                        };

                        let response;
                        try {
                            response = await axios.post('/api/v1/projects/batch-create', requestData);
                        } catch (error) {
                            // 检查是否是批量创建的部分失败情况 (400或207状态码)
                            // 新的统一响应格式下，这些也会在响应中包含完整数据
                            if (error.response && (error.response.status === 400 || error.response.status === 207) && error.response.data?.data) {
                                response = error.response; // 将错误响应当作成功响应处理
                            } else {
                                throw error; // 重新抛出真正的错误
                            }
                        }
                        
                        const modal = bootstrap.Modal.getInstance(document.getElementById('projectModal'));
                        modal.hide();
                        
                        // 适配新的统一响应格式
                        const apiResponse = response.data;
                        const result = apiResponse.data; // 批量操作数据在 data.data 中
                        
                        // 显示批量创建结果
                        let message = `${apiResponse.message}\n成功: ${result.success_count} 个项目\n失败: ${result.failure_count} 个项目`;
                        
                        if (result.failure_count > 0) {
                            message += '\n\n失败的项目：';
                            result.results.filter(r => !r.success).forEach(r => {
                                message += `\n• ${r.name}: ${r.error}`;
                            });
                        }
                        
                        // 显示批量创建结果给用户
                        alert(message);
                        
                        await this.loadProjects();
                        this.resetAddProjectState();
                    } catch (error) {
                        console.error('Failed to batch create projects:', error);
                        alert('批量创建项目失败: ' + (error.response?.data?.error || error.message));
                    } finally {
                        this.projectSaving = false;
                    }
                },
                editProject(project) {
                    const projectCopy = { ...project };
                    if (projectCopy.webhooks && Array.isArray(projectCopy.webhooks)) {
                        projectCopy.webhook_ids = projectCopy.webhooks.map(wh => wh.id);
                    } else {
                        projectCopy.webhook_ids = [];
                    }
                    this.currentProject = projectCopy;
                    this.isEditing = true;
                    const modal = new bootstrap.Modal(document.getElementById('projectModal'));
                    modal.show();
                },
                async testConnection() {
                    if (!this.urlParseForm.url || !this.urlParseForm.access_token) {
                        return;
                    }
                    
                    this.connectionTesting = true;
                    this.connectionTestResult = null;
                    
                    try {
                        const response = await axios.post('/api/v1/gitlab/test-connection', {
                            url: this.urlParseForm.url,
                            access_token: this.urlParseForm.access_token
                        });
                        
                        this.connectionTestResult = response.data.data;
                    } catch (error) {
                        console.error('Failed to test connection:', error);
                        this.connectionTestResult = {
                            success: false,
                            message: error.response?.data?.error || '连接测试失败'
                        };
                    } finally {
                        this.connectionTesting = false;
                    }
                },
                async parseProjectURL() {
                    if (!this.urlParseForm.url || !this.urlParseForm.access_token) {
                        return;
                    }
                    
                    this.urlParsing = true;
                    this.urlParseStep = 'parsing';
                    
                    try {
                        // 首先尝试组扫描API
                        const response = await axios.post('/api/v1/projects/scan-group', {
                            url: this.urlParseForm.url,
                            access_token: this.urlParseForm.access_token
                        });
                        
                        this.scannedData = response.data.data;
                        
                        if (this.scannedData.group_info) {
                            // 是组，进入批量选择模式
                            this.isBatchMode = true;
                            this.urlParseStep = 'batch_select';
                        } else if (this.scannedData.projects && this.scannedData.projects.length === 1) {
                            // 是单个项目，使用原有流程
                            this.isBatchMode = false;
                            const project = this.scannedData.projects[0];
                            this.parsedProjectInfo = {
                                gitlab_project_id: project.id,
                                name: project.name,
                                description: project.description,
                                web_url: project.web_url,
                                path_with_namespace: project.path_with_namespace,
                                default_branch: project.default_branch,
                                visibility: project.visibility
                            };
                            this.urlParseStep = 'confirm';
                        }
                    } catch (error) {
                        console.error('Failed to parse URL:', error);
                        alert('解析URL失败: ' + (error.response?.data?.error || error.message));
                        this.urlParseStep = 'input';
                    } finally {
                        this.urlParsing = false;
                    }
                },
                async saveProject() {
                    this.projectSaving = true;
                    
                    try {
                        if (this.isEditing) {
                            // 编辑模式：只发送后端需要的字段，确保类型正确
                            const payload = {
                                name: this.currentProject.name,
                                url: this.currentProject.url,
                                description: this.currentProject.description,
                                access_token: this.currentProject.access_token,
                                auto_manage_webhook: this.currentProject.auto_manage_webhook,
                                webhook_ids: Array.isArray(this.currentProject.webhook_ids) ? this.currentProject.webhook_ids : []
                            };
                            await axios.put(`/api/v1/projects/${this.currentProject.id}`, payload);
                        } else {
                            // 添加模式：使用解析出的项目信息
                            let webhookId = null;
                            
                            // 处理webhook配置
                            if (this.singleWebhookConfig.use_existing && this.singleWebhookConfig.existing_webhook_id) {
                                // 使用现有webhook
                                webhookId = this.singleWebhookConfig.existing_webhook_id;
                            } else if (!this.singleWebhookConfig.use_existing && 
                                       this.singleWebhookConfig.new_webhook.name && 
                                       this.singleWebhookConfig.new_webhook.url) {
                                // 创建新webhook
                                try {
                                    const webhookResponse = await axios.post('/api/v1/webhooks', {
                                        name: this.singleWebhookConfig.new_webhook.name,
                                        url: this.singleWebhookConfig.new_webhook.url,
                                        description: this.singleWebhookConfig.new_webhook.description,
                                        is_active: this.singleWebhookConfig.new_webhook.is_active
                                    });
                                    webhookId = webhookResponse.data.data.id;
                                } catch (webhookError) {
                                    console.error('Failed to create webhook:', webhookError);
                                    throw new Error('创建Webhook失败: ' + (webhookError.response?.data?.error || webhookError.message));
                                }
                            }
                            
                            const projectData = {
                                gitlab_project_id: this.parsedProjectInfo.gitlab_project_id,
                                name: this.parsedProjectInfo.name,
                                url: this.parsedProjectInfo.web_url,
                                description: this.parsedProjectInfo.description || '',
                                access_token: this.urlParseForm.access_token,
                                webhook_id: webhookId
                            };
                            
                            await axios.post('/api/v1/projects', projectData);
                        }
                        
                        const modal = bootstrap.Modal.getInstance(document.getElementById('projectModal'));
                        modal.hide();
                        
                        await this.loadProjects();
                        
                        // 重置状态
                        if (!this.isEditing) {
                            this.resetAddProjectState();
                        }
                    } catch (error) {
                        console.error('Failed to save project:', error);
                        // 适配新的统一响应格式
                        const errorMessage = error.response?.data?.message || error.response?.data?.error || error.message;
                        alert('保存项目失败: ' + errorMessage);
                    } finally {
                        this.projectSaving = false;
                    }
                },
                async deleteProject(projectId) {
                    if (!confirm('确定要删除这个项目吗？')) {
                        return;
                    }
                    
                    try {
                        await axios.delete(`/api/v1/projects/${projectId}`);
                        await this.loadProjects();
                    } catch (error) {
                        console.error('Failed to delete project:', error);
                        alert('删除项目失败');
                    }
                },
                async manageWebhooks(project) {
                    this.selectedProject = project;
                    await this.loadWebhooks();
                    const modal = new bootstrap.Modal(document.getElementById('webhookModal'));
                    modal.show();
                },
                isWebhookLinked(webhookId) {
                    if (!this.selectedProject || !this.selectedProject.webhooks) {
                        return false;
                    }
                    return this.selectedProject.webhooks.some(w => w.id === webhookId);
                },
                async toggleWebhook(webhookId) {
                    try {
                        const isLinked = this.isWebhookLinked(webhookId);
                        if (isLinked) {
                            await axios.delete(`/api/v1/project-webhooks/${this.selectedProject.id}/${webhookId}`);
                        } else {
                            await axios.post(`/api/v1/project-webhooks`, {
                                project_id: this.selectedProject.id,
                                webhook_id: webhookId
                            });
                        }
                        await this.loadProjects();
                    } catch (error) {
                        console.error('Failed to toggle webhook:', error);
                        alert('操作失败');
                    }
                },
                async syncGitLabWebhook(project) {
                    this.syncingWebhook = project.id;
                    
                    try {
                        const response = await axios.post(`/api/v1/projects/${project.id}/sync-gitlab-webhook`);
                        const result = response.data.data;
                        
                        if (!result.success) {
                            alert(`GitLab Webhook同步失败: ${result.message}`);
                        }
                        
                        if (result.success) {
                            await this.loadProjects();
                        }
                    } catch (error) {
                        console.error('Failed to sync GitLab webhook:', error);
                        alert('同步GitLab Webhook失败: ' + (error.response?.data?.error || error.message));
                    } finally {
                        this.syncingWebhook = null;
                    }
                },
                getWebhooksText(webhooks) {
                    if (!webhooks || webhooks.length === 0) return '无';
                    return webhooks.map(w => w.name).join(', ');
                },
                extractGroupFromProject(project) {
                    // 从项目URL中提取完整路径，用于智能分组
                    if (!project.url) return ['未分组'];
                    
                    try {
                        const url = new URL(project.url);
                        const pathParts = url.pathname.split('/').filter(p => p);
                        
                        if (pathParts.length >= 2) {
                            // 返回除了最后一个项目名的所有路径部分
                            return pathParts.slice(0, -1);
                        }
                    } catch (e) {
                        console.warn('解析项目URL失败:', project.url, e);
                    }
                    
                    return ['未分组'];
                },
                createSmartGroups(projects) {
                    if (!projects || projects.length === 0) return {};
                    
                    // 最大组大小阈值
                    const MAX_GROUP_SIZE = 10;
                    
                    // 构建路径树和项目映射
                    const pathTree = {};
                    const projectsByPath = {};
                    
                    projects.forEach(project => {
                        const pathParts = this.extractGroupFromProject(project);
                        
                        // 为这个项目的每个可能的分组级别添加项目
                        for (let depth = 1; depth <= pathParts.length; depth++) {
                            const pathKey = pathParts.slice(0, depth).join('/');
                            
                            if (!projectsByPath[pathKey]) {
                                projectsByPath[pathKey] = [];
                            }
                            projectsByPath[pathKey].push(project);
                            
                            // 构建树结构用于层级关系
                            let currentNode = pathTree;
                            for (let i = 0; i < depth; i++) {
                                const part = pathParts[i];
                                if (!currentNode[part]) {
                                    currentNode[part] = {};
                                }
                                currentNode = currentNode[part];
                            }
                        }
                    });
                    
                    // 选择最佳的分组级别
                    const optimalGroups = {};
                    const processedProjects = new Set();
                    
                    // 按路径长度从短到长排序，优先处理顶级分组
                    const sortedPaths = Object.keys(projectsByPath).sort((a, b) => {
                        const aDepth = a.split('/').length;
                        const bDepth = b.split('/').length;
                        if (aDepth !== bDepth) return aDepth - bDepth;
                        return a.localeCompare(b);
                    });
                    
                    sortedPaths.forEach(pathKey => {
                        const groupProjects = projectsByPath[pathKey];
                        
                        // 检查这个路径的项目是否已经被更细分的组处理了
                        const unprocessedProjects = groupProjects.filter(p => !processedProjects.has(p.id));
                        
                        if (unprocessedProjects.length === 0) return;
                        
                        // 如果这个组的项目数量合适，或者是最深层级，就使用这个分组
                        const isDeepestLevel = !this.hasSubGroups(pathKey, sortedPaths);
                        
                        if (unprocessedProjects.length <= MAX_GROUP_SIZE || isDeepestLevel) {
                            // 使用这个分组级别
                            const displayName = this.formatGroupName(pathKey);
                            optimalGroups[displayName] = unprocessedProjects.sort((a, b) => a.name.localeCompare(b.name));
                            
                            // 标记这些项目已被处理
                            unprocessedProjects.forEach(p => processedProjects.add(p.id));
                        }
                    });
                    
                    return optimalGroups;
                },
                hasSubGroups(pathKey, allPaths) {
                    // 检查是否有子组（更深层级的路径）包含这个路径的项目
                    return allPaths.some(otherPath => 
                        otherPath !== pathKey && 
                        otherPath.startsWith(pathKey + '/') &&
                        otherPath.split('/').length === pathKey.split('/').length + 1
                    );
                },
                formatGroupName(pathKey) {
                    // 格式化组名显示
                    const parts = pathKey.split('/');
                    
                    if (parts.length === 1) {
                        return parts[0];
                    } else if (parts.length === 2) {
                        return `${parts[0]} / ${parts[1]}`;
                    } else {
                        // 对于很深的路径，显示最后两级
                        return `...${parts[parts.length - 2]} / ${parts[parts.length - 1]}`;
                    }
                },
            },
            mounted() {
                this.loadProjects();
                this.loadGitLabConfig();
                this.loadWebhooks();
                
                // 调用父类的mounted方法
                if (CommonMixin.mounted) {
                    CommonMixin.mounted.call(this);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>