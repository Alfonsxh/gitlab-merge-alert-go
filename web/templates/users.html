{{define "content"}}
<div id="app">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">用户管理</h1>
        <button type="button" class="btn btn-primary" @click="showAddModal">
            <i class="bi bi-plus"></i> 添加用户
        </button>
    </div>

    <!-- 用户列表 -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>邮箱</th>
                            <th>姓名</th>
                            <th>手机号</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="user in users" :key="user.id">
                            <td v-text="user.id">-</td>
                            <td v-text="user.email">-</td>
                            <td v-text="user.name || '-'">-</td>
                            <td v-text="user.phone">-</td>
                            <td v-text="formatDate(user.created_at)">-</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" @click="editUser(user)">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" @click="deleteUser(user.id)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 添加/编辑用户模态框 -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" v-text="isEditing ? '编辑用户' : '添加用户'">用户管理</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="saveUser">
                        <div class="mb-3">
                            <label for="email" class="form-label">邮箱 *</label>
                            <input type="email" class="form-control" id="email" v-model="currentUser.email" required>
                            <div class="form-text">请输入GitLab上的用户邮箱</div>
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">手机号 *</label>
                            <input type="tel" class="form-control" id="phone" v-model="currentUser.phone" required>
                            <div class="form-text">请输入企业微信上注册的手机号</div>
                        </div>
                        <div class="mb-3">
                            <label for="name" class="form-label">姓名</label>
                            <input type="text" class="form-control" id="name" v-model="currentUser.name">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="saveUser" :disabled="!currentUser.email || !currentUser.phone" v-text="isEditing ? '更新' : '添加'">
                        保存
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp } = Vue;

createApp({
    data() {
        return {
            users: [],
            currentUser: {
                id: null,
                email: '',
                phone: '',
                name: ''
            },
            isEditing: false
        }
    },
    methods: {
        async loadUsers() {
            try {
                const response = await axios.get('/api/v1/users');
                this.users = response.data.data;
            } catch (error) {
                console.error('Failed to load users:', error);
                alert('加载用户列表失败');
            }
        },
        showAddModal() {
            this.currentUser = {
                id: null,
                email: '',
                phone: '',
                name: ''
            };
            this.isEditing = false;
            const modal = new bootstrap.Modal(document.getElementById('userModal'));
            modal.show();
        },
        editUser(user) {
            this.currentUser = { ...user };
            this.isEditing = true;
            const modal = new bootstrap.Modal(document.getElementById('userModal'));
            modal.show();
        },
        async saveUser() {
            try {
                if (this.isEditing) {
                    await axios.put(`/api/v1/users/${this.currentUser.id}`, this.currentUser);
                } else {
                    await axios.post('/api/v1/users', this.currentUser);
                }
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('userModal'));
                modal.hide();
                
                await this.loadUsers();
                alert(this.isEditing ? '用户更新成功' : '用户添加成功');
            } catch (error) {
                console.error('Failed to save user:', error);
                alert('保存用户失败: ' + (error.response?.data?.error || error.message));
            }
        },
        async deleteUser(userId) {
            if (!confirm('确定要删除这个用户吗？')) {
                return;
            }
            
            try {
                await axios.delete(`/api/v1/users/${userId}`);
                await this.loadUsers();
                alert('用户删除成功');
            } catch (error) {
                console.error('Failed to delete user:', error);
                alert('删除用户失败');
            }
        },
        formatDate(dateString) {
            return new Date(dateString).toLocaleString('zh-CN');
        }
    },
    mounted() {
        this.loadUsers();
    }
}).mount('#app');
</script>
{{end}}